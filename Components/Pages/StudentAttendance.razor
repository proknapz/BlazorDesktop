@page "/StudentAttendance"
@inject NavigationManager NavigationManager
@inject ApplicationDbContext DbContext
@using Microsoft.EntityFrameworkCore

<style>
    .class-button {
        background-color: white;
        color: black;
        border: 1px solid #ccc;
        margin: 0.5rem;
        padding: 0.75rem 1.5rem;
        transition: background-color 0.2s ease-in-out;
        border-radius: 5px;
        cursor: pointer;
    }

        .class-button:hover {
            background-color: #f0f0f0;
        }

    .button-container {
        display: flex;
        flex-wrap: wrap;
        gap: 0.5rem;
    }
</style>

<h3>Select a Class</h3>

@if (!string.IsNullOrEmpty(errorMessage))
{
    <p class="text-danger">@errorMessage</p>
}
else if (classList == null)
{
    <p><em>Loading...</em></p>
}
else
{
    <div class="button-container">
        @foreach (var c in classList)
        {
            <button class="class-button" @onclick="() => LoadAttendanceRecords(c.classId)">
                @c.courseName - @c.courseNumber
            </button>
        }
    </div>
}

@if (selectedClassId != null)
{
    var selectedClass = classList?.FirstOrDefault(c => c.classId == selectedClassId);
    if (selectedClass != null)
    {
        <h4 class="mt-4">Attendance Records for @selectedClass.courseName - @selectedClass.courseNumber</h4>
    }

    @if (attendanceList == null)
    {
        <p><em>Loading attendance records...</em></p>
    }
    else if (!attendanceList.Any())
    {
        <p>No attendance records found for this class.</p>
    }
    else
    {
        <table class="table table-bordered mt-3">
            <thead>
                <tr>
                    <th>Student Name</th>
                    <th>Arrival Time</th>
                    <th>Is Present</th>
                    <th>Is Excused</th>
                    <th>Class Date</th>
                    <th>Current IP</th>
                    <th>Actions</th> <!-- New column for delete -->
                </tr>
            </thead>
            <tbody>
                @foreach (var record in attendanceList)
                {
                    <tr>
                        <td>@record.Student.FirstName @record.Student.LastName</td>
                        <td>@record.ArrivalTime.ToString(@"hh\:mm\:ss")</td>
                        <td><input type="checkbox" @bind="record.IsPresent" /></td>
                        <td><input type="checkbox" @bind="record.IsExcused" /></td>
                        <td>@record.ClassDate.ToShortDateString()</td>
                        <td>@record.CurrentIP</td>
                        <td>
                            <button class="btn btn-danger btn-sm" @onclick="() => DeleteAttendance(record.AttendanceId)">Delete</button>
                        </td>
                    </tr>
                }
            </tbody>
        </table>
        <button class="btn btn-primary mt-3" @onclick="SaveChanges">Save Changes</button>
    }
}

@code {
    private List<Class>? classList;
    private List<AttendanceRecord>? attendanceList;
    private string? errorMessage;
    private int? selectedClassId;

    protected override async Task OnInitializedAsync()
    {
        try
        {
            classList = await DbContext.Classes.ToListAsync();
        }
        catch (Exception ex)
        {
            errorMessage = $"Error: {ex.Message}";
        }
    }

    private async Task LoadAttendanceRecords(int classId)
    {
        selectedClassId = classId;
        try
        {
            attendanceList = await DbContext.AttendanceRecords
                .Where(a => a.ClassId == classId)
                .Include(a => a.Student)
                .ToListAsync();
        }
        catch (Exception ex)
        {
            errorMessage = $"Error loading attendance: {ex.Message}";
        }
    }

    private async Task SaveChanges()
    {
        try
        {
            DbContext.AttendanceRecords.UpdateRange(attendanceList);
            await DbContext.SaveChangesAsync();
            errorMessage = null;
        }
        catch (Exception ex)
        {
            errorMessage = $"Error saving changes: {ex.Message}";
        }
    }

    private async Task DeleteAttendance(int attendanceId)
    {
        try
        {
            var recordToDelete = await DbContext.AttendanceRecords.FindAsync(attendanceId);
            if (recordToDelete != null)
            {
                DbContext.AttendanceRecords.Remove(recordToDelete);
                await DbContext.SaveChangesAsync();

                // Reload updated attendance list
                if (selectedClassId.HasValue)
                {
                    await LoadAttendanceRecords(selectedClassId.Value);
                }
            }
        }
        catch (Exception ex)
        {
            errorMessage = $"Error deleting record: {ex.Message}";
        }
    }
}
